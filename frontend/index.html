<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Kanjiten - Spaced Repetition Learning</title>
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui,
            sans-serif;
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          min-height: 100vh;
          color: #333;
        }

        /* Top Navigation Bar */
        .top-nav {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: 60px;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-bottom: 1px solid #e1e8ed;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0 20px;
          z-index: 1000;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-logo {
          font-size: 24px;
          font-weight: bold;
          color: #2c3e50;
        }

        .nav-buttons {
          display: flex;
          gap: 10px;
        }

        .nav-btn {
          padding: 8px 16px;
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s ease;
        }

        .nav-btn:hover {
          background: #e9ecef;
        }

        .nav-btn.primary {
          background: #495057;
          color: white;
          border-color: #495057;
        }

        .nav-btn.primary:hover {
          background: #343a40;
        }

        .container {
          max-width: 1200px;
          margin: 60px auto 0;
          padding: 20px;
        }

        .scene {
          display: none;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          min-height: 80vh;
        }

        .scene.active {
          display: block;
        }

        h1,
        h2,
        h3 {
          color: #2c3e50;
          margin-bottom: 20px;
          text-align: center;
        }

        .auth-form {
          max-width: 400px;
          margin: 0 auto;
          padding: 40px;
        }

        .input-group {
          margin-bottom: 20px;
        }

        label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
        }

        input,
        select,
        textarea {
          width: 100%;
          padding: 15px;
          border: 2px solid #e1e8ed;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
          outline: none;
          border-color: #6c757d;
          box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
        }

        .btn {
          padding: 15px 30px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin: 10px;
          min-width: 120px;
        }

        .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .btn-primary {
          background: linear-gradient(135deg, #495057, #6c757d);
          color: white;
        }

        .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(73, 80, 87, 0.3);
        }

        .btn-secondary {
          background: #f8f9fa;
          color: #495057;
          border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
          background: #e9ecef;
        }

        .btn-danger {
          background: #dc3545;
          color: white;
        }

        .btn-success {
          background: #28a745;
          color: white;
        }

        .btn-warning {
          background: #ffc107;
          color: #212529;
        }

        .status-message {
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
        }

        .status-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }

        .status-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }

        .dashboard-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
          margin-top: 30px;
        }

        .dashboard-card {
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
          transition: transform 0.3s ease;
          text-align: center;
          min-height: 300px;
          display: flex;
          flex-direction: column;
          justify-content: center;
        }

        .dashboard-card:hover {
          transform: translateY(-5px);
        }

        .progress-bar {
          width: 100%;
          height: 20px;
          background: #e9ecef;
          border-radius: 10px;
          overflow: hidden;
          margin: 10px 0;
        }

        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #6c757d, #495057);
          transition: width 0.3s ease;
          border-radius: 10px;
        }

        .level-header {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin: 10px 0;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .level-header:hover {
          background: #e9ecef;
        }

        .level-header.expanded {
          background: #e9ecef;
        }

        .kanji-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 15px;
          margin: 20px 0;
          overflow: hidden;
          transition: all 0.3s ease;
        }

        .kanji-grid:not(.expanded) {
          display: none;
        }

        .kanji-grid.expanded {
          display: grid;
        }
        
        .kanji-card {
          background: white;
          border: 2px solid #e1e8ed;
          border-radius: 10px;
          padding: 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          min-height: 120px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          position: relative;
        }

        .kanji-card:hover {
          border-color: #6c757d;
          transform: translateY(-2px);
        }

        .kanji-card.learned {
          background: #d4edda;
          border-color: #28a745;
        }

        .kanji-card.in-review {
          background: #fff3cd;
          border-color: #ffc107;
        }

        .kanji-card.selected {
          background: #e9ecef;
          border-color: #6c757d;
          transform: scale(0.95);
        }

        .kanji-character {
          font-size: 48px;
          font-weight: bold;
          margin-bottom: 10px;
        }

        .kanji-translation {
          font-size: 14px;
          color: #666;
        }

        .study-interface {
          text-align: center;
          padding: 40px;
          position: relative;
        }

        .question-card {
          background: white;
          padding: 60px;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          margin: 30px 0;
          min-height: 300px;
          display: flex;
          flex-direction: column;
          justify-content: center;
        }

        .question-text {
          font-size: 32px;
          margin-bottom: 20px;
        }

        .answer-text {
          font-size: 72px;
          font-weight: bold;
          color: #495057;
          margin: 20px 0;
        }

        .answer-buttons {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin: 30px 0;
        }

        .study-mode-controls {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.95);
          padding: 15px 20px;
          border-radius: 25px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
          backdrop-filter: blur(10px);
          z-index: 100;
        }

        .variation-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 10px;
          margin: 10px 0;
          border-left: 4px solid #6c757d;
        }

        .tabs {
          display: flex;
          border-bottom: 2px solid #e1e8ed;
          margin-bottom: 30px;
        }

        .tab {
          padding: 15px 30px;
          cursor: pointer;
          border-bottom: 3px solid transparent;
          transition: all 0.3s ease;
        }

        .tab.active {
          border-bottom-color: #6c757d;
          background: #f8f9fa;
        }

        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin: 30px 0;
        }

        .stat-card {
          background: white;
          padding: 25px;
          border-radius: 15px;
          text-align: center;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-value {
          font-size: 36px;
          font-weight: bold;
          color: #495057;
        }

        .stat-label {
          font-size: 14px;
          color: #666;
          margin-top: 10px;
        }

        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
        }

        .modal.active {
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background: white;
          padding: 40px;
          border-radius: 20px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        }

        .close {
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          color: #999;
        }

        .close:hover {
          color: #333;
        }

        .floating-btn {
          padding: 12px 20px;
          background: rgba(255, 255, 255, 0.9);
          border: none;
          border-radius: 25px;
          cursor: pointer;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
        }

        .guest-notice {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          text-align: center;
        }

        @media (max-width: 768px) {
          .container {
            padding: 10px;
            margin-top: 70px;
          }

          .top-nav {
            padding: 0 10px;
          }

          .nav-logo {
            font-size: 20px;
          }

          .nav-btn {
            padding: 6px 12px;
            font-size: 12px;
          }

          .scene {
            padding: 20px;
          }

          .dashboard-grid {
            grid-template-columns: 1fr;
          }

          .answer-buttons {
            flex-direction: column;
            align-items: center;
          }

          .kanji-grid {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          }
        }
      </style>
    </head>
    <body>
      <!-- Top Navigation Bar -->
      <div class="top-nav">
        <div class="nav-logo">üå∏ Kanjiten</div>
        <div class="nav-buttons">
          <button
            class="nav-btn"
            id="backBtn"
            onclick="goBack()"
            style="display: none"
          >
            ‚Üê Back
          </button>
          <button
            class="nav-btn"
            id="settingsBtn"
            onclick="loadScene('settingsScene')"
            style="display: none"
          >
            Settings
          </button>
          <button
            class="nav-btn"
            id="signInBtn"
            onclick="loadScene('loginScene')"
            style="display: none"
          >
            Sign In
          </button>
          <button
            class="nav-btn primary"
            id="signOutBtn"
            onclick="signOut()"
            style="display: none"
          >
            Sign Out
          </button>
        </div>
      </div>

      <div class="container">
        <!-- Login Scene -->
        <div class="scene" id="loginScene">
          <div class="auth-form">
            <h1>üå∏ Kanjiten</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #666">
              Master Japanese kanji with spaced repetition
            </p>

<div class="input-group">
  <label for="email">Email</label>
  <input type="email" id="email" placeholder="Enter email" />
</div>
<div class="input-group">
  <label for="username">Username</label>
  <input type="text" id="username" placeholder="Enter username" />
</div>

            <div class="input-group">
              <label for="password">Password</label>
              <input type="password" id="password" placeholder="Enter password" />
            </div>

            <div style="text-align: center">
              <button class="btn btn-primary" onclick="signIn()">Sign In</button>
              <button class="btn btn-secondary" onclick="signUp()">
                Sign Up
              </button>
              <button class="btn btn-secondary" onclick="signInAnonymous()">
                Guest Mode
              </button>
            </div>

            <div id="authStatus"></div>
          </div>
        </div>

        <!-- Dashboard Scene -->
        <div class="scene active" id="dashboardScene">
          <div id="guestNotice" class="guest-notice" style="display: none;">
            You're in guest mode. Your progress won't be saved permanently. 
            <a href="#" onclick="loadScene('loginScene')" style="color: #495057; font-weight: bold;">Sign up</a> to save your progress!
          </div>

          <h1>Welcome back, <span id="welcomeName">Guest</span>! üéå</h1>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="kanjiLearned">0</div>
              <div class="stat-label">Kanji in Review</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="reviewsDue">0</div>
              <div class="stat-label">Reviews Due</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="accuracy">0%</div>
              <div class="stat-label">Accuracy</div>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h3>Decks</h3>
              <p>Browse and study kanji by level</p>
              <button class="btn btn-primary" onclick="loadScene('decksScene')">
                Browse Decks
              </button>
            </div>

            <div class="dashboard-card">
              <h3>Study</h3>
              <p>Review kanji that are due for study</p>
              <button class="btn btn-primary" onclick="startReview()">
                Start Review
              </button>
            </div>

            <div class="dashboard-card">
              <h3>Cram Kanji</h3>
              <p>Quick practice with selected kanji</p>
              <button class="btn btn-primary" onclick="loadScene('cramScene')">
                Cram Session
              </button>
            </div>

            <div class="dashboard-card">
              <h3>Settings</h3>
              <p>Customize your learning experience</p>
              <button
                class="btn btn-primary"
                onclick="loadScene('settingsScene')"
              >
                Settings
              </button>
            </div>
          </div>
        </div>

        <!-- Decks Scene -->
        <div class="scene" id="decksScene">
          <h2>üìö Kanji Decks</h2>

          <div style="margin-bottom: 30px; text-align: center">
            <label for="studyAmount">Study Amount: </label>
            <select id="studyAmount">
              <option value="5">5 cards</option>
              <option value="10">10 cards</option>
              <option value="20">20 cards</option>
              <option value="all">All cards</option>
            </select>
            <button
              class="btn btn-primary"
              onclick="startLevelStudy()"
              style="margin-left: 20px"
            >
              Study Selected
            </button>
          </div>

          <div id="kanjiLevels"></div>
        </div>

        <!-- Study Scene -->
        <div class="scene" id="studyScene">
          <div style="text-align: center; margin-bottom: 20px">
            <div>Progress: <span id="studyProgress">0/0</span></div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="studyProgressBar"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="study-interface">
            <div class="question-card">
              <div id="questionText" class="question-text">
                Click "Show Answer" to begin
              </div>
              <div
                id="answerText"
                class="answer-text"
                style="display: none"
              ></div>

              <button
                class="btn btn-primary"
                id="showAnswerBtn"
                onclick="showAnswer()"
              >
                Show Answer
              </button>

              <div
                class="answer-buttons"
                id="answerButtons"
                style="display: none"
              >
                <button class="btn btn-danger" onclick="submitAnswer(1)">
                  Wrong
                </button>
                <button class="btn btn-warning" onclick="submitAnswer(2)">
                  Hard
                </button>
                <button class="btn btn-success" onclick="submitAnswer(3)">
                  Good
                </button>
                <button class="btn btn-primary" onclick="submitAnswer(4)">
                  Easy
                </button>
              </div>
            </div>
          </div>

          <div class="study-mode-controls">
            <label for="studyQuestionMode">Question Mode: </label>
            <select id="studyQuestionMode" onchange="updateStudyQuestionMode()">
              <option value="meaning-first">
                Show Reading + Meaning ‚Üí Word
              </option>
              <option value="kanji-first">Show Word ‚Üí Reading + Meaning</option>
            </select>
          </div>
        </div>

        <!-- Kanji Detail Scene -->
        <div class="scene" id="kanjiDetailScene">
          <div style="text-align: center">
            <div
              class="kanji-character"
              id="detailKanjiChar"
              style="font-size: 120px"
            >
              Êº¢
            </div>
            <h2 id="detailKanjiReading">„Åã„Çì</h2>
            <p
              id="detailKanjiMeaning"
              style="font-size: 24px; margin-bottom: 30px"
            >
              chinese
            </p>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 30px;
              margin: 30px 0;
            "
          >
            <div>
              <h3>Details</h3>
              <p><strong>Level:</strong> <span id="detailLevel">N/A</span></p>
              <p><strong>JLPT:</strong> <span id="detailJLPT">N/A</span></p>
              <p>
                <strong>Status:</strong>
                <span id="detailStatus">Not learned</span>
              </p>
              <p>
                <strong>Accuracy:</strong> <span id="detailAccuracy">0%</span>
              </p>
              <p>
                <strong>Next Review:</strong>
                <span id="detailNextReview">N/A</span>
              </p>
            </div>
            <div>
              <h3>Actions</h3>
              <button
                class="btn btn-primary"
                id="addToReviewBtn"
                onclick="addKanjiToReview()"
              >
                Add to Review
              </button>
              <button
                class="btn btn-danger"
                id="removeFromReviewBtn"
                onclick="removeKanjiFromReview()"
                style="display: none"
              >
                Remove from Review
              </button>
              <button class="btn btn-secondary" onclick="openDrawingScene()">
                Practice Writing
              </button>
            </div>
          </div>

          <div>
            <h3>Mnemonic</h3>
            <textarea
              id="mnemonicText"
              placeholder="Enter your memory aid here..."
              style="min-height: 100px"
            ></textarea>
            <button class="btn btn-primary" onclick="saveMnemonic()">
              Save Mnemonic
            </button>
          </div>

          <div id="kanjiVariations" style="margin-top: 30px">
            <h3>Words using this kanji</h3>
            <div id="variationsList"></div>
          </div>
        </div>

        <!-- Drawing Scene -->
        <div class="scene" id="drawingScene">
          <h2>‚úèÔ∏è Practice Writing</h2>

          <div style="text-align: center">
            <div
              class="kanji-character"
              id="drawingKanjiChar"
              style="font-size: 120px"
            >
              Êº¢
            </div>
            <p
              id="drawingKanjiMeaning"
              style="font-size: 24px; margin-bottom: 30px"
            >
              chinese
            </p>
          </div>

          <div style="text-align: center">
            <canvas
              id="mainDrawingCanvas"
              class="drawing-canvas"
              width="400"
              height="400"
            ></canvas>

            <div class="drawing-controls">
              <button class="btn btn-secondary" onclick="clearMainCanvas()">
                Clear Canvas
              </button>
              <button class="btn btn-secondary" onclick="toggleMainEraser()">
                Toggle Eraser
              </button>
              <button class="btn btn-secondary" onclick="toggleBackground()">
                Toggle Guidelines
              </button>
            </div>
          </div>
        </div>

        <!-- Cram Scene -->
        <div class="scene" id="cramScene">
          <h2>üéØ Cram Session Setup</h2>

          <div style="text-align: center; margin-bottom: 30px">
            <div style="margin-bottom: 20px">
              <label for="cramQuestionMode">Question Mode: </label>
              <select id="cramQuestionMode" onchange="updateCramQuestionMode()">
                <option value="meaning-first">
                  Show Reading + Meaning ‚Üí Word
                </option>
                <option value="kanji-first">Show Word ‚Üí Reading + Meaning</option>
              </select>
            </div>

            <button class="btn btn-primary" onclick="selectAllKanji()">
              Select All
            </button>
            <button class="btn btn-secondary" onclick="deselectAllKanji()">
              Deselect All
            </button>
            <button
              class="btn btn-success"
              onclick="startCramSession()"
              id="startCramBtn"
              disabled
            >
              Start Cram (0 selected)
            </button>
          </div>

          <div id="cramKanjiLevels"></div>
        </div>

        <!-- Cram Study Scene -->
        <div class="scene" id="cramStudyScene">
          <div style="text-align: center; margin-bottom: 20px">
            <div>
              Progress: <span id="cramProgress">0/0</span> | Correct:
              <span id="cramCorrect">0</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="cramProgressBar"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="study-interface">
            <div class="question-card">
              <div id="cramQuestionText" class="question-text">Loading...</div>
              <div
                id="cramAnswerText"
                class="answer-text"
                style="display: none"
              ></div>

              <button
                class="btn btn-primary"
                id="cramShowAnswerBtn"
                onclick="showCramAnswer()"
              >
                Show Answer
              </button>

              <div
                class="answer-buttons"
                id="cramAnswerButtons"
                style="display: none"
              >
                <button class="btn btn-danger" onclick="submitCramAnswer(false)">
                  Incorrect
                </button>
                <button class="btn btn-success" onclick="submitCramAnswer(true)">
                  Correct
                </button>
              </div>
            </div>
          </div>

          <div class="study-mode-controls">
            <label for="cramQuestionMode2">Question Mode: </label>
            <select id="cramQuestionMode2" onchange="updateCramQuestionMode()">
              <option value="meaning-first">
                Show Reading + Meaning ‚Üí Word
              </option>
              <option value="kanji-first">Show Word ‚Üí Reading + Meaning</option>
            </select>
          </div>
        </div>

        <!-- Settings Scene -->
        <div class="scene" id="settingsScene">
          <h2>‚öôÔ∏è Settings</h2>

          <div style="max-width: 600px; margin: 0 auto">
            <div class="input-group">
              <label for="profileName">Profile Name</label>
              <input type="text" id="profileName" placeholder="Enter your name" />
              <button class="btn btn-primary" onclick="saveProfileName()">
                Save Name
              </button>
            </div>

            <div class="input-group">
              <label for="maxLevel">Maximum Study Level</label>
              <select id="maxLevel">
                <option value="10">Level 10 (Easiest)</option>
                <option value="9">Level 9</option>
                <option value="8">Level 8</option>
                <option value="7">Level 7</option>
                <option value="6">Level 6</option>
                <option value="5">Level 5</option>
                <option value="4">Level 4</option>
                <option value="3">Level 3</option>
                <option value="2">Level 2</option>
                <option value="1">Level 1 (Hardest)</option>
              </select>
            </div>

            <div class="input-group">
              <label for="jlptLevel">JLPT Level Filter</label>
              <select id="jlptLevel">
                <option value="all">All Levels</option>
                <option value="N5">N5 (Beginner)</option>
                <option value="N4">N4</option>
                <option value="N3">N3</option>
                <option value="N2">N2</option>
                <option value="N1">N1 (Advanced)</option>
              </select>
            </div>

            <div class="input-group">
              <label for="maxInterval">Maximum SRS Interval (days)</label>
              <input
                type="number"
                id="maxInterval"
                min="1"
                max="365"
                value="180"
              />
            </div>

            <div class="input-group">
              <label>
                <input type="checkbox" id="showProgress" /> Show progress bars
                during study
              </label>
            </div>

            <div class="input-group">
              <label>
                <input type="checkbox" id="showDrawing" /> Enable drawing practice
              </label>
            </div>

            <div style="text-align: center; margin-top: 40px">
              <button class="btn btn-primary" onclick="saveSettings()">
                Save Settings
              </button>
              <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for kanji details -->
      <div class="modal" id="kanjiModal">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <div id="modalContent"></div>
        </div>
      </div>

      <script>
        const SAMPLE_KANJI = [
          // Level 10 (Easiest)
          {
            id: 1,
            character: '‰∏Ä',
            readings: ['„ÅÑ„Å°', '„Å≤„Å®'],
            meanings: ['one'],
            level: 10,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∏Ä„Å§',
                reading: '„Å≤„Å®„Å§',
                meaning: 'one thing',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∏Ä‰∫∫',
                reading: '„Å≤„Å®„Çä',
                meaning: 'one person',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∏ÄÊó•',
                reading: '„ÅÑ„Å°„Å´„Å°',
                meaning: 'one day',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∏ÄÂπ¥',
                reading: '„ÅÑ„Å°„Å≠„Çì',
                meaning: 'one year',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∏ÄÁï™',
                reading: '„ÅÑ„Å°„Å∞„Çì',
                meaning: 'number one, first',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏ÄËà¨',
                reading: '„ÅÑ„Å£„Å±„Çì',
                meaning: 'general',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏ÄËá¥',
                reading: '„ÅÑ„Å£„Å°',
                meaning: 'agreement',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏ÄÊµÅ',
                reading: '„ÅÑ„Å°„Çä„ÇÖ„ÅÜ',
                meaning: 'first class',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏ÄÁû¨',
                reading: '„ÅÑ„Å£„Åó„ÇÖ„Çì',
                meaning: 'instant',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: '‰∏ÄÁõÆ',
                reading: '„Å≤„Å®„ÇÅ',
                meaning: 'glance',
                type: 'kun',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 2,
            character: '‰∫å',
            readings: ['„Å´', '„Åµ„Åü'],
            meanings: ['two'],
            level: 10,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∫å„Å§',
                reading: '„Åµ„Åü„Å§',
                meaning: 'two things',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∫å‰∫∫',
                reading: '„Åµ„Åü„Çä',
                meaning: 'two people',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∫åÊó•',
                reading: '„Åµ„Å§„Åã',
                meaning: 'two days',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: '‰∫åÊôÇ',
                reading: '„Å´„Åò',
                meaning: "two o'clock",
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∫åÈöé',
                reading: '„Å´„Åã„ÅÑ',
                meaning: 'second floor',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫åÈáç',
                reading: '„Å´„Åò„ÇÖ„ÅÜ',
                meaning: 'double',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫åÊ¨°',
                reading: '„Å´„Åò',
                meaning: 'secondary',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫åËÄÖ',
                reading: '„Å´„Åó„ÇÉ',
                meaning: 'two parties',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫åÂÖÉ',
                reading: '„Å´„Åí„Çì',
                meaning: 'dualism',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: '‰∫åÂæã',
                reading: '„Å´„Çä„Å§',
                meaning: 'two laws',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 3,
            character: '‰∏â',
            readings: ['„Åï„Çì', '„Åø'],
            meanings: ['three'],
            level: 10,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∏â„Å§',
                reading: '„Åø„Å£„Å§',
                meaning: 'three things',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∏â‰∫∫',
                reading: '„Åï„Çì„Å´„Çì',
                meaning: 'three people',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: '‰∏âÊó•',
                reading: '„Åø„Å£„Åã',
                meaning: 'three days',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: '‰∏âÊôÇ',
                reading: '„Åï„Çì„Åò',
                meaning: "three o'clock",
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∏âËßí',
                reading: '„Åï„Çì„Åã„Åè',
                meaning: 'triangle',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏âÊúà',
                reading: '„Åï„Çì„Åå„Å§',
                meaning: 'March',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏âËÄÖ',
                reading: '„Åï„Çì„Åó„ÇÉ',
                meaning: 'three parties',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏âÊ¨°',
                reading: '„Åï„Çì„Åò',
                meaning: 'tertiary',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏â‰Ωç',
                reading: '„Åï„Çì„ÅÑ',
                meaning: 'third place',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: '‰∏âÊòß',
                reading: '„Åï„Çì„Åæ„ÅÑ',
                meaning: 'absorption',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 4,
            character: 'Âõõ',
            readings: ['„Åó', '„Çà„Çì', '„Çà'],
            meanings: ['four'],
            level: 10,
            jlpt: 'N5',
            variations: [
              {
                word: 'Âõõ„Å§',
                reading: '„Çà„Å£„Å§',
                meaning: 'four things',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Âõõ‰∫∫',
                reading: '„Çà„Å´„Çì',
                meaning: 'four people',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'ÂõõÊó•',
                reading: '„Çà„Å£„Åã',
                meaning: 'four days',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'ÂõõÊôÇ',
                reading: '„Çà„Åò',
                meaning: "four o'clock",
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'ÂõõÊúà',
                reading: '„Åó„Åå„Å§',
                meaning: 'April',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'ÂõõËßí',
                reading: '„Åó„Åã„Åè',
                meaning: 'square',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'ÂõõÂ≠£',
                reading: '„Åó„Åç',
                meaning: 'four seasons',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'ÂõõÊñπ',
                reading: '„Åó„Åª„ÅÜ',
                meaning: 'all directions',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'ÂõõËÇ¢',
                reading: '„Åó„Åó',
                meaning: 'limbs',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'ÂõõÈù¢',
                reading: '„Åó„ÇÅ„Çì',
                meaning: 'four sides',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 5,
            character: '‰∫î',
            readings: ['„Åî', '„ÅÑ„Å§'],
            meanings: ['five'],
            level: 10,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∫î„Å§',
                reading: '„ÅÑ„Å§„Å§',
                meaning: 'five things',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∫î‰∫∫',
                reading: '„Åî„Å´„Çì',
                meaning: 'five people',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: '‰∫îÊó•',
                reading: '„ÅÑ„Å§„Åã',
                meaning: 'five days',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: '‰∫îÊôÇ',
                reading: '„Åî„Åò',
                meaning: "five o'clock",
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∫îÊúà',
                reading: '„Åî„Åå„Å§',
                meaning: 'May',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫îÊÑü',
                reading: '„Åî„Åã„Çì',
                meaning: 'five senses',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫î‰Ωì',
                reading: '„Åî„Åü„ÅÑ',
                meaning: 'whole body',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫îÂàÜ',
                reading: '„Åî„Å∂',
                meaning: 'equal',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫îËáì',
                reading: '„Åî„Åû„ÅÜ',
                meaning: 'five organs',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: '‰∫îËº™',
                reading: '„Åî„Çä„Çì',
                meaning: 'Olympics',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          // Level 9
          {
            id: 6,
            character: 'Ê∞¥',
            readings: ['„Åô„ÅÑ', '„Åø„Åö'],
            meanings: ['water'],
            level: 9,
            jlpt: 'N5',
            variations: [
              {
                word: 'Ê∞¥',
                reading: '„Åø„Åö',
                meaning: 'water',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Ê∞¥ÈÅì',
                reading: '„Åô„ÅÑ„Å©„ÅÜ',
                meaning: 'water supply',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Ê∞¥ÊõúÊó•',
                reading: '„Åô„ÅÑ„Çà„ÅÜ„Å≥',
                meaning: 'Wednesday',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Ê∞¥Ê≥≥',
                reading: '„Åô„ÅÑ„Åà„ÅÑ',
                meaning: 'swimming',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Ê∞¥ÂàÜ',
                reading: '„Åô„ÅÑ„Å∂„Çì',
                meaning: 'moisture',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Ê∞¥Èù¢',
                reading: '„Åô„ÅÑ„ÇÅ„Çì',
                meaning: 'water surface',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Ê∞¥Ê∫ñ',
                reading: '„Åô„ÅÑ„Åò„ÇÖ„Çì',
                meaning: 'level',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Ê∞¥Ë≥™',
                reading: '„Åô„ÅÑ„Åó„Å§',
                meaning: 'water quality',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Ê∞¥ÈäÄ',
                reading: '„Åô„ÅÑ„Åé„Çì',
                meaning: 'mercury',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'Ê∞¥ËÑà',
                reading: '„Åô„ÅÑ„Åø„ÇÉ„Åè',
                meaning: 'water vein',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 7,
            character: 'ÁÅ´',
            readings: ['„Åã', '„Å≤'],
            meanings: ['fire'],
            level: 9,
            jlpt: 'N5',
            variations: [
              {
                word: 'ÁÅ´',
                reading: '„Å≤',
                meaning: 'fire',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'ÁÅ´ÊõúÊó•',
                reading: '„Åã„Çà„ÅÜ„Å≥',
                meaning: 'Tuesday',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'ÁÅ´‰∫ã',
                reading: '„Åã„Åò',
                meaning: 'fire accident',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Ëä±ÁÅ´',
                reading: '„ÅØ„Å™„Å≥',
                meaning: 'fireworks',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'ÁÅ´ÁÅΩ',
                reading: '„Åã„Åï„ÅÑ',
                meaning: 'fire disaster',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'ÁÅ´Âäõ',
                reading: '„Åã„Çä„Çá„Åè',
                meaning: 'firepower',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'ÁÅ´ÂÇ∑',
                reading: '„ÇÑ„Åë„Å©',
                meaning: 'burn',
                type: 'kun',
                jlpt: 'N2',
              },
              {
                word: 'ÁÅ´Â±±',
                reading: '„Åã„Åñ„Çì',
                meaning: 'volcano',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'ÁÅ´Ëä±',
                reading: '„Å≤„Å∞„Å™',
                meaning: 'spark',
                type: 'kun',
                jlpt: 'N1',
              },
              {
                word: 'ÁÅ´ÊÄ•',
                reading: '„Åã„Åç„ÇÖ„ÅÜ',
                meaning: 'urgent',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 8,
            character: 'Êú®',
            readings: ['„ÇÇ„Åè', '„Åç'],
            meanings: ['tree', 'wood'],
            level: 9,
            jlpt: 'N5',
            variations: [
              {
                word: 'Êú®',
                reading: '„Åç',
                meaning: 'tree',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Êú®ÊõúÊó•',
                reading: '„ÇÇ„Åè„Çà„ÅÜ„Å≥',
                meaning: 'Thursday',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Êú®Êùê',
                reading: '„ÇÇ„Åè„Åñ„ÅÑ',
                meaning: 'lumber',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Ê§çÊú®',
                reading: '„ÅÜ„Åà„Åç',
                meaning: 'plant',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'Êú®ÈÄ†',
                reading: '„ÇÇ„Åè„Åû„ÅÜ',
                meaning: 'wooden',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Êú®Ë£Ω',
                reading: '„ÇÇ„Åè„Åõ„ÅÑ',
                meaning: 'wooden made',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Êú®Â∑•',
                reading: '„ÇÇ„Å£„Åì„ÅÜ',
                meaning: 'woodwork',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êú®ÁõÆ',
                reading: '„ÇÇ„Åè„ÇÅ',
                meaning: 'wood grain',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êú®Èô∞',
                reading: '„Åì„Åã„Åí',
                meaning: 'shade of tree',
                type: 'kun',
                jlpt: 'N1',
              },
              {
                word: 'Êú®Ë≥™',
                reading: '„ÇÇ„Åè„Åó„Å§',
                meaning: 'woody',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          // Level 8
          {
            id: 9,
            character: '‰∫∫',
            readings: ['„Åò„Çì', '„Å≤„Å®'],
            meanings: ['person'],
            level: 8,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∫∫',
                reading: '„Å≤„Å®',
                meaning: 'person',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∫∫Èñì',
                reading: '„Å´„Çì„Åí„Çì',
                meaning: 'human being',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Â§ß‰∫∫',
                reading: '„Åä„Å®„Å™',
                meaning: 'adult',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: '‰∫∫Âè£',
                reading: '„Åò„Çì„Åì„ÅÜ',
                meaning: 'population',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∫∫Áîü',
                reading: '„Åò„Çì„Åõ„ÅÑ',
                meaning: 'life',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫∫Áâ©',
                reading: '„Åò„Çì„Å∂„Å§',
                meaning: 'person, character',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∫∫Ê†º',
                reading: '„Åò„Çì„Åã„Åè',
                meaning: 'personality',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫∫Êùê',
                reading: '„Åò„Çì„Åñ„ÅÑ',
                meaning: 'human resources',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∫∫ÊüÑ',
                reading: '„Å≤„Å®„Åå„Çâ',
                meaning: 'personality',
                type: 'kun',
                jlpt: 'N1',
              },
              {
                word: '‰∫∫Á®Æ',
                reading: '„Åò„Çì„Åó„ÇÖ',
                meaning: 'race',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 10,
            character: 'Êó•',
            readings: ['„Å´„Å°', '„Å≤'],
            meanings: ['day', 'sun'],
            level: 8,
            jlpt: 'N5',
            variations: [
              {
                word: '‰ªäÊó•',
                reading: '„Åç„Çá„ÅÜ',
                meaning: 'today',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Êó•Êú¨',
                reading: '„Å´„Åª„Çì',
                meaning: 'Japan',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'ÊØéÊó•',
                reading: '„Åæ„ÅÑ„Å´„Å°',
                meaning: 'every day',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰ºëÊó•',
                reading: '„Åç„ÇÖ„ÅÜ„Åò„Å§',
                meaning: 'holiday',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Êó•‰ªò',
                reading: '„Å≤„Å•„Åë',
                meaning: 'date',
                type: 'kun',
                jlpt: 'N3',
              },
              {
                word: 'Êó•Á®ã',
                reading: '„Å´„Å£„Å¶„ÅÑ',
                meaning: 'schedule',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Êó•Â∏∏',
                reading: '„Å´„Å°„Åò„Çá„ÅÜ',
                meaning: 'daily',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êó•Ë®ò',
                reading: '„Å´„Å£„Åç',
                meaning: 'diary',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êó•ÊöÆ„Çå',
                reading: '„Å≤„Åê„Çå',
                meaning: 'sunset',
                type: 'kun',
                jlpt: 'N1',
              },
              {
                word: 'Êó•Ëùï',
                reading: '„Å´„Å£„Åó„Çá„Åè',
                meaning: 'solar eclipse',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 11,
            character: 'Êú¨',
            readings: ['„Åª„Çì', '„ÇÇ„Å®'],
            meanings: ['book', 'origin'],
            level: 8,
            jlpt: 'N5',
            variations: [
              {
                word: 'Êú¨',
                reading: '„Åª„Çì',
                meaning: 'book',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Êó•Êú¨',
                reading: '„Å´„Åª„Çì',
                meaning: 'Japan',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Êú¨ÂΩì',
                reading: '„Åª„Çì„Å®„ÅÜ',
                meaning: 'really',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Êú¨Â±ã',
                reading: '„Åª„Çì„ÇÑ',
                meaning: 'bookstore',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Êú¨Êù•',
                reading: '„Åª„Çì„Çâ„ÅÑ',
                meaning: 'originally',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Âü∫Êú¨',
                reading: '„Åç„Åª„Çì',
                meaning: 'basic',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Êú¨Ë≥™',
                reading: '„Åª„Çì„Åó„Å§',
                meaning: 'essence',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êú¨Ê†º',
                reading: '„Åª„Çì„Åã„Åè',
                meaning: 'full-scale',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Êú¨Èü≥',
                reading: '„Åª„Çì„Å≠',
                meaning: 'true feelings',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'Êú¨Ê∫ê',
                reading: '„Åª„Çì„Åí„Çì',
                meaning: 'source',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 12,
            character: 'Â§ß',
            readings: ['„Å†„ÅÑ', '„Åä„Åä'],
            meanings: ['big', 'large'],
            level: 7,
            jlpt: 'N5',
            variations: [
              {
                word: 'Â§ß„Åç„ÅÑ',
                reading: '„Åä„Åä„Åç„ÅÑ',
                meaning: 'big',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Â§ßÂ≠¶',
                reading: '„Å†„ÅÑ„Åå„Åè',
                meaning: 'university',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Â§ßÂàá',
                reading: '„Åü„ÅÑ„Åõ„Å§',
                meaning: 'important',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Â§ßÂ§â',
                reading: '„Åü„ÅÑ„Å∏„Çì',
                meaning: 'very',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Â§ß‰Ωì',
                reading: '„Å†„ÅÑ„Åü„ÅÑ',
                meaning: 'mostly',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â§ßÁµ±È†ò',
                reading: '„Å†„ÅÑ„Å®„ÅÜ„Çä„Çá„ÅÜ',
                meaning: 'president',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â§ßË¶èÊ®°',
                reading: '„Å†„ÅÑ„Åç„Åº',
                meaning: 'large-scale',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Â§ßÂπÖ',
                reading: '„Åä„Åä„ÅØ„Å∞',
                meaning: 'drastic',
                type: 'kun',
                jlpt: 'N2',
              },
              {
                word: 'Â§ßÁæ©',
                reading: '„Åü„ÅÑ„Åé',
                meaning: 'great cause',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'Â§ßÂô®',
                reading: '„Åü„ÅÑ„Åç',
                meaning: 'great talent',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 13,
            character: 'Â∞è',
            readings: ['„Åó„Çá„ÅÜ', '„Å°„ÅÑ', '„Åì'],
            meanings: ['small'],
            level: 7,
            jlpt: 'N5',
            variations: [
              {
                word: 'Â∞è„Åï„ÅÑ',
                reading: '„Å°„ÅÑ„Åï„ÅÑ',
                meaning: 'small',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Â∞èÂ≠¶Ê†°',
                reading: '„Åó„Çá„ÅÜ„Åå„Å£„Åì„ÅÜ',
                meaning: 'elementary school',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'Â∞èË™¨',
                reading: '„Åó„Çá„ÅÜ„Åõ„Å§',
                meaning: 'novel',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Â∞èÂåÖ',
                reading: '„Åì„Å•„Å§„Åø',
                meaning: 'package',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'Â∞èÂ£≤',
                reading: '„Åì„ÅÜ„Çä',
                meaning: 'retail',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â∞èÂûã',
                reading: '„Åì„Åå„Åü',
                meaning: 'small size',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â∞èË¶èÊ®°',
                reading: '„Åó„Çá„ÅÜ„Åç„Åº',
                meaning: 'small-scale',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Â∞èÈä≠',
                reading: '„Åì„Åú„Å´',
                meaning: 'small change',
                type: 'kun',
                jlpt: 'N2',
              },
              {
                word: 'Â∞èÂ∫∑',
                reading: '„Åó„Çá„ÅÜ„Åì„ÅÜ',
                meaning: 'lull',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'Â∞èÁ≤í',
                reading: '„Åì„Å§„Å∂',
                meaning: 'small grain',
                type: 'kun',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 14,
            character: '‰∏≠',
            readings: ['„Å°„ÇÖ„ÅÜ', '„Å™„Åã'],
            meanings: ['middle', 'inside'],
            level: 7,
            jlpt: 'N5',
            variations: [
              {
                word: '‰∏≠',
                reading: '„Å™„Åã',
                meaning: 'inside',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: '‰∏≠Â≠¶Ê†°',
                reading: '„Å°„ÇÖ„ÅÜ„Åå„Å£„Åì„ÅÜ',
                meaning: 'middle school',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: '‰∏≠ÂõΩ',
                reading: '„Å°„ÇÖ„ÅÜ„Åî„Åè',
                meaning: 'China',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∏≠ÂøÉ',
                reading: '„Å°„ÇÖ„ÅÜ„Åó„Çì',
                meaning: 'center',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: '‰∏≠Â§Æ',
                reading: '„Å°„ÇÖ„ÅÜ„Åä„ÅÜ',
                meaning: 'center',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏≠Èñì',
                reading: '„Å°„ÇÖ„ÅÜ„Åã„Çì',
                meaning: 'middle',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: '‰∏≠Êñ≠',
                reading: '„Å°„ÇÖ„ÅÜ„Å†„Çì',
                meaning: 'interruption',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏≠Á´ã',
                reading: '„Å°„ÇÖ„ÅÜ„Çä„Å§',
                meaning: 'neutral',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: '‰∏≠Êû¢',
                reading: '„Å°„ÇÖ„ÅÜ„Åô„ÅÜ',
                meaning: 'center',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: '‰∏≠Â∫∏',
                reading: '„Å°„ÇÖ„ÅÜ„Çà„ÅÜ',
                meaning: 'moderation',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 15,
            character: 'Â±±',
            readings: ['„Åï„Çì', '„ÇÑ„Åæ'],
            meanings: ['mountain'],
            level: 6,
            jlpt: 'N5',
            variations: [
              {
                word: 'Â±±',
                reading: '„ÇÑ„Åæ',
                meaning: 'mountain',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'ÂØåÂ£´Â±±',
                reading: '„Åµ„Åò„Åï„Çì',
                meaning: 'Mount Fuji',
                type: 'on',
                jlpt: 'N5',
              },
              {
                word: 'ÁôªÂ±±',
                reading: '„Å®„Åñ„Çì',
                meaning: 'mountain climbing',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'ÁÅ´Â±±',
                reading: '„Åã„Åñ„Çì',
                meaning: 'volcano',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Â±±ËÑà',
                reading: '„Åï„Çì„Åø„ÇÉ„Åè',
                meaning: 'mountain range',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â±±È†Ç',
                reading: '„Åï„Çì„Å°„Çá„ÅÜ',
                meaning: 'summit',
                type: 'on',
                jlpt: 'N3',
              },
              {
                word: 'Â±±Êûó',
                reading: '„Åï„Çì„Çä„Çì',
                meaning: 'mountain forest',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Â±±Èñì',
                reading: '„Åï„Çì„Åã„Çì',
                meaning: 'among mountains',
                type: 'on',
                jlpt: 'N2',
              },
              {
                word: 'Â±±Â≤≥',
                reading: '„Åï„Çì„Åå„Åè',
                meaning: 'mountains',
                type: 'on',
                jlpt: 'N1',
              },
              {
                word: 'Â±±È∫ì',
                reading: '„Åï„Çì„Çç„Åè',
                meaning: 'foot of mountain',
                type: 'on',
                jlpt: 'N1',
              },
            ],
          },
          {
            id: 16,
            character: 'Â∑ù',
            readings: ['„Åõ„Çì', '„Åã„Çè'],
            meanings: ['river'],
            level: 6,
            jlpt: 'N5',
            variations: [
              {
                word: 'Â∑ù',
                reading: '„Åã„Çè',
                meaning: 'river',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Â∞èÂ∑ù',
                reading: '„Åä„Åå„Çè',
                meaning: 'stream',
                type: 'kun',
                jlpt: 'N5',
              },
              {
                word: 'Ê≤≥Â∑ù',
                reading: '„Åã„Åõ„Çì',
                meaning: 'rivers',
                type: 'on',
                jlpt: 'N4',
              },
              {
                word: 'Â∑ùËæ∫',
                reading: '„Åã„Çè„Åπ',
                meaning: 'riverside',
                type: 'kun',
                jlpt: 'N4',
              },
              {
                word: 'Â∑ùÂè£',
                reading: '„Åã„Çè„Åê„Å°',
                meaning: 'river mouth',
                type: 'kun',
                jlpt: 'N3',
              },
              {
                word: 'Â∑ùÂéü',
                reading: '„Åã„Çè„Çâ',
                meaning: 'riverbed',
                type: 'kun',
                jlpt: 'N3',
              },
              {
                word: 'Â∑ù‰∏ä',
                reading: '„Åã„Çè„Åã„Åø',
                meaning: 'upstream',
                type: 'kun',
                jlpt: 'N2',
              },
              {
                word: 'Â∑ù‰∏ã',
                reading: '„Åã„Çè„Åó„ÇÇ',
                meaning: 'downstream',
                type: 'kun',
                jlpt: 'N2',
              },
              {
                word: 'Â∑ùÁ≠ã',
                reading: '„Åã„Çè„Åô„Åò',
                meaning: 'course of river',
                type: 'kun',
                jlpt: 'N1',
              },
              {
                word: 'Â∑ùÂ∫ä',
                reading: '„Åã„Çè„Å©„Åì',
                meaning: 'riverbed',
                type: 'kun',
                jlpt: 'N1',
              },
            ],
          },
        ];

        // API Configuration
const API_CONFIG = {
  baseURL: 'https://kanjiten.onrender.com/api',  // Add /api here
  endpoints: {
    auth: '/auth',
    progress: '/progress', 
    settings: '/settings',
  },
};
        let drawingState = {
    isDrawing: false,
    isErasing: false,
    lastX: 0,
    lastY: 0,
  };
        // Application State
        let gameState = {
          user: null,
          isSignedIn: false,
          isAnonymous: false,
          authToken: null,
          currentScene: 'loginScene',
          studySession: {
            kanji: [],
            currentIndex: 0,
            showingAnswer: false,
            correct: 0,
            total: 0,
            questionMode: 'meaning-first',
          },
          cramSession: {
            kanji: [],
            currentIndex: 0,
            showingAnswer: false,
            correct: 0,
            total: 0,
            selectedKanji: new Set(),
            questionMode: 'meaning-first',
          },
          selectedKanji: null,
          settings: {
            profileName: '',
            maxLevel: 10,
            jlptLevel: 'all',
            maxInterval: 180,
            showProgress: true,
            showDrawing: true,
          },
          kanjiData: new Map(),
          reviewQueue: [],
          expandedLevel: null,
        };

        // Initialize kanji data with SRS information
        function initializeKanjiData() {
          SAMPLE_KANJI.forEach((kanji) => {
            gameState.kanjiData.set(kanji.id, {
              ...kanji,
              learned: false,
              inReview: false,
              interval: 1,
              ease: 2.5,
              consecutiveCorrect: 0,
              totalReviews: 0,
              correctReviews: 0,
              lastReview: null,
              nextReview: null,
              mnemonic: '',
            });
          });
        }

        // Utility function to make API calls
  async function apiCall(endpoint, method = 'GET', data = null) {
    console.log(`Making API call: ${method} ${API_CONFIG.baseURL}${endpoint}`);
    
    const config = {
      method,
      headers: {
        'Content-Type': 'application/json',
      },
    };

    if (gameState.authToken) {
      config.headers['Authorization'] = `Bearer ${gameState.authToken}`;
    }

    if (data && method !== 'GET') {
      config.body = JSON.stringify(data);
    }

    const url = method === 'GET' && data
      ? `${API_CONFIG.baseURL}${endpoint}?${new URLSearchParams(data)}`
      : `${API_CONFIG.baseURL}${endpoint}`;

    try {
      const response = await fetch(url, config);
      
      // Check if the response is ok
      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (parseError) {
          // If response isn't JSON, use the text
          try {
            const errorText = await response.text();
            if (errorText) errorMessage = errorText;
          } catch (textError) {
            // Use the original error message
          }
        }
        
        throw new Error(errorMessage);
      }

      const result = await response.json();
      return result;
    } catch (error) {
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        throw new Error('Unable to connect to server. Please check your connection.');
      }
      throw error;
    }
  }
 async function signIn() {
  const email = document.getElementById('email').value.trim();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const signInBtn = document.querySelector('.btn-primary[onclick="signIn()"]');

  if (!signInBtn) return;

  const originalText = signInBtn.textContent;
  signInBtn.disabled = true;
  signInBtn.textContent = 'Signing in...';

  if (!email || !password) {
    showAuthStatus('Please enter email and password', 'error');
    signInBtn.disabled = false;
    signInBtn.textContent = originalText;
    return;
  }

  try {
    const response = await apiCall('/auth/login', 'POST', { email, password });
    
    if (response.success && response.session) {
      gameState.user = {
        username: response.user?.username || 'User',
        id: response.user?.id,
        isAnonymous: response.user?.isAnonymous || false,
      };
      gameState.isSignedIn = true;
      gameState.isAnonymous = response.user?.isAnonymous || false;
      gameState.authToken = response.session.access_token; // Use access_token from session
      gameState.settings.profileName = gameState.user.username;

      if (gameState.authToken) {
        localStorage.setItem('authToken', gameState.authToken);
      }

      showAuthStatus('Sign in successful!', 'success');
      
      // Update UI
      document.getElementById('signOutBtn').style.display = 'block';
      document.getElementById('signInBtn').style.display = 'none';

      setTimeout(async () => {
        loadScene('dashboardScene');
        await loadGameData();
      }, 1000);
    } else {
      throw new Error('Invalid response from server');
    }
  } catch (error) {
    console.error('Authentication error:', error);
    showAuthStatus(`Sign in failed: ${error.message}`, 'error');
  } finally {
    signInBtn.disabled = false;
    signInBtn.textContent = originalText;
  }
}
        
 async function signUp() {
  const email = document.getElementById('email').value.trim();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const signUpBtn = document.querySelector('.btn-secondary[onclick="signUp()"]');

  if (!signUpBtn) return;

  const originalText = signUpBtn.textContent;
  signUpBtn.disabled = true;
  signUpBtn.textContent = 'Creating account...';

  if (!email || !username || !password) {
    showAuthStatus('Please enter email, username, and password', 'error');
    signUpBtn.disabled = false;
    signUpBtn.textContent = originalText;
    return;
  }

  if (username.length < 3) {
    showAuthStatus('Username must be at least 3 characters long', 'error');
    signUpBtn.disabled = false;
    signUpBtn.textContent = originalText;
    return;
  }

  if (!isPasswordValid(password)) {
    showAuthStatus(
      'Password must be at least 8 characters with uppercase, lowercase, number, and special character',
      'error'
    );
    signUpBtn.disabled = false;
    signUpBtn.textContent = originalText;
    return;
  }

  try {
    const response = await apiCall('/auth/register', 'POST', { username, password, email });

    if (response.success && response.session) {
      gameState.user = {
        username: response.user?.username || username,
        id: response.user?.id,
        isAnonymous: false,
      };
      gameState.isSignedIn = true;
      gameState.isAnonymous = false;
      gameState.authToken = response.session.access_token; // Use access_token from session
      gameState.settings.profileName = gameState.user.username;

      if (gameState.authToken) {
        localStorage.setItem('authToken', gameState.authToken);
      }

      showAuthStatus('Account created successfully!', 'success');
      
      // Update UI
      document.getElementById('signOutBtn').style.display = 'block';
      document.getElementById('signInBtn').style.display = 'none';

      setTimeout(async () => {
        loadScene('dashboardScene');
        await loadGameData();
      }, 1000);
    } else {
      throw new Error('Invalid response from server');
    }
  } catch (error) {
    console.error('Sign up error:', error);
    showAuthStatus(`Sign up failed: ${error.message}`, 'error');
  } finally {
    signUpBtn.disabled = false;
    signUpBtn.textContent = originalText;
  }
}
async function signInAnonymous() {
  const signInBtn = document.querySelector('.btn-secondary[onclick="signInAnonymous()"]');
  
  if (!signInBtn) return;

  const originalText = signInBtn.textContent;
  signInBtn.disabled = true;
  signInBtn.textContent = 'Creating guest session...';

  try {
    const response = await apiCall('/auth/anonymous', 'POST', {});

    if (response.success && response.session) {
      gameState.user = {
        username: response.user.username,
        id: response.user.id,
        isAnonymous: true,
      };
      gameState.isSignedIn = true;
      gameState.isAnonymous = true;
      gameState.authToken = response.session.access_token; // Use access_token from session
      gameState.settings.profileName = 'Guest';

      if (gameState.authToken) {
        localStorage.setItem('authToken', gameState.authToken);
      }

      showAuthStatus('Signed in as guest!', 'success');
      
      // Update UI
      document.getElementById('signOutBtn').style.display = 'block';
      document.getElementById('signInBtn').style.display = 'none';
      document.getElementById('guestNotice').style.display = 'block';

      setTimeout(() => {
        loadScene('dashboardScene');
      }, 1000);
    } else {
      throw new Error('Invalid response from server');
    }
  } catch (error) {
    console.error('Anonymous sign in error:', error);
    showAuthStatus('Failed to sign in as guest: ' + error.message, 'error');
  } finally {
    signInBtn.disabled = false;
    signInBtn.textContent = originalText;
  }
}
async function validateTokenAndAutoLogin(token) {
  try {
    gameState.authToken = token;
    
    // Try to get user settings to validate token
    const settingsResponse = await apiCall('/settings', 'GET');

    // If successful, we have a valid token
    gameState.isSignedIn = true;
    gameState.settings = {
      ...gameState.settings,
      ...settingsResponse.settings,
    };

    // Update UI
    document.getElementById('signOutBtn').style.display = 'block';
    document.getElementById('signInBtn').style.display = 'none';
    
    loadScene('dashboardScene');
    await loadGameData();
  } catch (error) {
    console.error('Token validation failed:', error);
    localStorage.removeItem('authToken');
    
    // Reset state
    gameState.authToken = null;
    gameState.isSignedIn = false;
    gameState.isAnonymous = false;
    gameState.user = null;
    
    // Show sign in UI
    document.getElementById('signOutBtn').style.display = 'none';
    document.getElementById('signInBtn').style.display = 'block';
    
    loadScene('loginScene');
  }
}// 6. Fix the signOut function:
async function signOut() {
  try {
    if (gameState.authToken) {
      // Save data before signing out (if not anonymous)
      if (!gameState.isAnonymous) {
        await saveGameData();
      }

      // Call logout endpoint
      try {
        await apiCall('/auth/logout', 'POST');
      } catch (error) {
        console.log('Logout API call failed:', error);
        // Continue with local logout even if API call fails
      }
    }
  } catch (error) {
    console.error('Error during sign out:', error);
  } finally {
    // Always perform local cleanup
    localStorage.removeItem('authToken');

    // Reset game state
    gameState.user = null;
    gameState.isSignedIn = false;
    gameState.isAnonymous = false;
    gameState.authToken = null;

    // Update UI
    document.getElementById('signOutBtn').style.display = 'none';
    document.getElementById('signInBtn').style.display = 'block';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('guestNotice').style.display = 'none';
    
    loadScene('loginScene');
  }
}

// 7. Add a new function to update dashboard UI:
function updateNavigationUI() {
  if (gameState.isSignedIn) {
    document.getElementById('signOutBtn').style.display = 'block';
    document.getElementById('signInBtn').style.display = 'none';
    
    if (gameState.isAnonymous) {
      document.getElementById('guestNotice').style.display = 'block';
    } else {
      document.getElementById('guestNotice').style.display = 'none';
    }
  } else {
    document.getElementById('signOutBtn').style.display = 'none';
    document.getElementById('signInBtn').style.display = 'block';
    document.getElementById('guestNotice').style.display = 'none';
  }
}
async function handleAuthFallback(email, username, password, isSignUp = false) {
    // This is a fallback for development/testing when server is not available
    console.warn('Using fallback authentication - not suitable for production');
    
    if (isSignUp) {
      // For signup, just create a new user
      const userId = 'user_' + Date.now();
      localStorage.setItem('fallback_user', JSON.stringify({
        id: userId,
        username: username,
        password: password, // In real app, this would be hashed
      }));
    } else {
      // For signin, check if user exists
      const storedUser = localStorage.getItem('fallback_user');
      if (!storedUser) {
        throw new Error('No account found. Please sign up first.');
      }
      
      const user = JSON.parse(storedUser);
      if (user.username !== username || user.password !== password) {
        throw new Error('Invalid username or password');
      }
    }

    // Return mock successful response
    return {
      success: true,
      user: {
        id: 'user_' + Date.now(),
        username: username,
      },
      token: 'fallback_token_' + Date.now(),
    };
  }

  function isPasswordValid(password) {
    if (!password || password.length < 8 || password.length > 128) {
      return false;
    }
    

    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasDigit = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

    return hasUpper && hasLower && hasDigit && hasSpecial;
  }
        function showAuthStatus(message, type) {
          const statusDiv = document.getElementById('authStatus');
          statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
          setTimeout(() => (statusDiv.innerHTML = ''), 3000);
        }

        // Scene Management
  function loadScene(sceneName) {
    document
      .querySelectorAll('.scene')
      .forEach((scene) => scene.classList.remove('active'));
    document.getElementById(sceneName).classList.add('active');
    gameState.currentScene = sceneName;

    // Show back button for all scenes except login and dashboard
    const showBackButton = !['loginScene', 'dashboardScene'].includes(sceneName);
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
      backBtn.style.display = showBackButton ? 'block' : 'none';
    }

    switch (sceneName) {
      case 'dashboardScene':
        updateDashboard();
        break;
      case 'decksScene':
        updateDecksScene();
        break;
      case 'cramScene':
        updateCramScene();
        break;
      case 'settingsScene':
        updateSettingsScene();
        break;
    }
  }
  function startAutoSave() {
    setInterval(async () => {
      if (gameState.isSignedIn && !gameState.isAnonymous) {
        try {
          await saveGameData();
          console.log('Auto-save completed');
        } catch (error) {
          console.error('Auto-save failed:', error);
        }
      }
    }, 30000); // Save every 30 seconds
  }

  function goBack() {
    switch (gameState.currentScene) {
      case 'decksScene':
      case 'cramScene':
      case 'settingsScene':
        loadScene('dashboardScene');
        break;
      case 'studyScene':
        loadScene('dashboardScene');
        break;
      case 'kanjiDetailScene':
        loadScene('decksScene');
        break;
      case 'drawingScene':
        if (gameState.selectedKanji) {
          loadScene('kanjiDetailScene');
        } else {
          loadScene('decksScene');
        }
        break;
      case 'cramStudyScene':
        loadScene('cramScene');
        break;
      default:
        loadScene('dashboardScene');
    }
  }
        // Dashboard Functions
        function updateDashboard() {
          document.getElementById('welcomeName').textContent =
            gameState.settings.profileName || 'User';

          const stats = calculateStats();
          document.getElementById('kanjiLearned').textContent =
            stats.kanjiLearned;
          document.getElementById('reviewsDue').textContent = stats.reviewsDue;
          document.getElementById('accuracy').textContent = stats.accuracy + '%';

          updateLevelProgress();
        }

        function calculateStats() {
          let kanjiLearned = 0;
          let reviewsDue = 0;
          let totalReviews = 0;
          let correctReviews = 0;

          gameState.kanjiData.forEach((kanji) => {
            if (kanji.inReview) {
              kanjiLearned++;
            }

            if (
              kanji.inReview &&
              (!kanji.nextReview || new Date() >= kanji.nextReview)
            ) {
              reviewsDue++;
            }

            totalReviews += kanji.totalReviews;
            correctReviews += kanji.correctReviews;
          });

          const accuracy =
            totalReviews > 0
              ? Math.round((correctReviews / totalReviews) * 100)
              : 0;
          return { kanjiLearned, reviewsDue, accuracy };
        }

        function updateLevelProgress() {
          const progressDiv = document.getElementById('levelProgress');
          let html = '';

          for (let level = 10; level >= 1; level--) {
            const levelKanji = Array.from(gameState.kanjiData.values()).filter(
              (k) => k.level === level
            );
            const learnedCount = levelKanji.filter((k) => k.learned).length;
            const totalCount = levelKanji.length;
            const percentage =
              totalCount > 0 ? (learnedCount / totalCount) * 100 : 0;

            html += `
              <div style="margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span>Level ${level}</span>
                  <span>${learnedCount}/${totalCount}</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
              </div>
            `;
          }

          progressDiv.innerHTML = html;
        }

        // Data Management
        async function saveGameData() {
          if (gameState.isAnonymous || !gameState.authToken) return;

          try {
            // Prepare kanji progress data
            const kanjiProgressData = Array.from(
              gameState.kanjiData.entries()
            ).map(([id, kanji]) => [
              id,
              {
                learned: kanji.learned,
                inReview: kanji.inReview,
                interval: kanji.interval,
                ease: kanji.ease,
                consecutiveCorrect: kanji.consecutiveCorrect,
                totalReviews: kanji.totalReviews,
                correctReviews: kanji.correctReviews,
                lastReview: kanji.lastReview
                  ? kanji.lastReview.toISOString()
                  : null,
                nextReview: kanji.nextReview
                  ? kanji.nextReview.toISOString()
                  : null,
                mnemonic: kanji.mnemonic || '',
              },
            ]);

await apiCall('/progress/bulk-update', 'POST', {
  kanjiProgressData,
});
            // Save settings
            await apiCall('/settings', 'PUT', gameState.settings);

            // Also save to localStorage as backup
            const saveData = {
              settings: gameState.settings,
              kanjiData: Array.from(gameState.kanjiData.entries()),
              lastSave: new Date().toISOString(),
            };
            localStorage.setItem('kanjiMasterSave', JSON.stringify(saveData));
          } catch (error) {
            console.error('Failed to save to server:', error);
            // Fall back to localStorage only
            const saveData = {
              settings: gameState.settings,
              kanjiData: Array.from(gameState.kanjiData.entries()),
              lastSave: new Date().toISOString(),
            };
            localStorage.setItem('kanjiMasterSave', JSON.stringify(saveData));
          }
        }

async function loadGameData() {
    if (gameState.isAnonymous || !gameState.authToken) {
      // For anonymous users, still try to load from localStorage
      const savedData = localStorage.getItem('kanjiMasterSave');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          if (data.settings) {
            gameState.settings = { ...gameState.settings, ...data.settings };
          }
          if (data.kanjiData) {
            data.kanjiData.forEach(([id, kanjiData]) => {
              if (gameState.kanjiData.has(id)) {
                const existingKanji = gameState.kanjiData.get(id);
                gameState.kanjiData.set(id, {
                  ...existingKanji,
                  ...kanjiData,
                  lastReview: kanjiData.lastReview ? new Date(kanjiData.lastReview) : null,
                  nextReview: kanjiData.nextReview ? new Date(kanjiData.nextReview) : null,
                });
              }
            });
          }
        } catch (e) {
          console.error('Failed to load local save data:', e);
        }
      }
      return;
    }

    try {
      // Initialize with base kanji data first
      if (gameState.kanjiData.size === 0) {
        initializeKanjiData();
      }

      // Load user progress
      const progressResponse = await apiCall('/progress', 'GET');
      
      // Merge with user progress
      if (progressResponse.progress && progressResponse.progress.length > 0) {
        progressResponse.progress.forEach((userKanji) => {
          if (gameState.kanjiData.has(userKanji.kanji_id)) {
            const existingKanji = gameState.kanjiData.get(userKanji.kanji_id);
            gameState.kanjiData.set(userKanji.kanji_id, {
              ...existingKanji,
              learned: userKanji.learned || false,
              inReview: userKanji.in_review || false,
              interval: userKanji.srs_interval || 1,
              ease: userKanji.ease_factor || 2.5,
              consecutiveCorrect: userKanji.consecutive_correct || 0,
              totalReviews: userKanji.total_reviews || 0,
              correctReviews: userKanji.correct_reviews || 0,
              lastReview: userKanji.last_review ? new Date(userKanji.last_review) : null,
              nextReview: userKanji.next_review ? new Date(userKanji.next_review) : null,
              mnemonic: userKanji.mnemonic || '',
            });
          }
        });
      }

      // Load user settings
      const settingsResponse = await apiCall('/settings', 'GET');
      if (settingsResponse.success && settingsResponse.settings) {
        gameState.settings = {
          ...gameState.settings,
          ...settingsResponse.settings,
        };
      }

      console.log('Data loaded successfully from server');
      
      // Update UI elements that depend on settings
      updateDashboard();
      
    } catch (error) {
      console.error('Failed to load from database:', error);
      
      // Fallback to localStorage
      const savedData = localStorage.getItem('kanjiMasterSave');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          if (data.settings) {
            gameState.settings = { ...gameState.settings, ...data.settings };
          }
          if (data.kanjiData) {
            data.kanjiData.forEach(([id, kanjiData]) => {
              if (gameState.kanjiData.has(id)) {
                const existingKanji = gameState.kanjiData.get(id);
                gameState.kanjiData.set(id, {
                  ...existingKanji,
                  ...kanjiData,
                  lastReview: kanjiData.lastReview ? new Date(kanjiData.lastReview) : null,
                  nextReview: kanjiData.nextReview ? new Date(kanjiData.nextReview) : null,
                });
              }
            });
          }
          console.log('Data loaded from localStorage backup');
        } catch (e) {
          console.error('Failed to load local save data:', e);
        }
      }
    }
  }
        // Study Functions
        function startReview() {
          if (gameState.kanjiData.size === 0) {
            alert('Kanji data not loaded yet. Please wait...');
            return;
          }

          const reviewKanji = Array.from(gameState.kanjiData.values()).filter(
            (k) => isKanjiDueForReview(k)
          );

          if (reviewKanji.length === 0) {
            alert('No reviews due! Come back later or study new kanji.');
            return;
          }

          startStudySession(reviewKanji);
        }

        function startLevelStudy() {
          if (gameState.kanjiData.size === 0) {
            alert('Kanji data not loaded yet. Please wait...');
            return;
          }

          let reviewKanji = Array.from(gameState.kanjiData.values()).filter((k) =>
            isKanjiDueForReview(k)
          );

          if (reviewKanji.length === 0) {
            const newKanji = Array.from(gameState.kanjiData.values()).filter(
              (k) =>
                !k.inReview &&
                !k.learned &&
                k.level <= gameState.settings.maxLevel &&
                (gameState.settings.jlptLevel === 'all' ||
                  k.jlpt === gameState.settings.jlptLevel)
            );

            const studyAmount = document.getElementById('studyAmount').value;
            if (studyAmount === 'all') {
              reviewKanji = newKanji;
            } else {
              const amount = parseInt(studyAmount);
              reviewKanji = newKanji.slice(0, amount);
            }

            reviewKanji.forEach((kanji) => {
              kanji.inReview = true;
              kanji.nextReview = new Date();
            });
          }

          if (reviewKanji.length === 0) {
            alert('No kanji available for study!');
            return;
          }

          startStudySession(reviewKanji);
        }

        function startStudySession(kanji) {
          gameState.studySession = {
            kanji: [...kanji].sort(() => Math.random() - 0.5),
            currentIndex: 0,
            showingAnswer: false,
            correct: 0,
            total: kanji.length,
            questionMode: gameState.studySession.questionMode || 'meaning-first',
          };

          loadScene('studyScene');

          const modeDropdown = document.getElementById('studyQuestionMode');
          if (modeDropdown) {
            modeDropdown.value = gameState.studySession.questionMode;
          }
          displayCurrentQuestion();
        }

        function updateStudyQuestionMode() {
          const mode = document.getElementById('studyQuestionMode').value;
          gameState.studySession.questionMode = mode;
          if (gameState.studySession.kanji.length > 0) {
            displayCurrentQuestion();
          }
        }

        function displayCurrentQuestion() {
          const session = gameState.studySession;

          if (!session.kanji || session.kanji.length === 0) {
            alert('No kanji in study session!');
            loadScene('dashboardScene');
            return;
          }

          if (session.currentIndex >= session.kanji.length) {
            alert(
              `Study session complete! Score: ${session.correct}/${session.total}`
            );
            saveGameData();
            loadScene('dashboardScene');
            return;
          }

          const currentKanji = session.kanji[session.currentIndex];
          const filteredVariations = getFilteredVariations(
            currentKanji,
            gameState.settings.jlptLevel
          );

          if (filteredVariations.length === 0) {
            session.currentIndex++;
            displayCurrentQuestion();
            return;
          }

          const randomVariation =
            filteredVariations[
              Math.floor(Math.random() * filteredVariations.length)
            ];

          let questionText, answerText;

          if (session.questionMode === 'meaning-first') {
            questionText = `${randomVariation.reading}\n${randomVariation.meaning}`;
            answerText = randomVariation.word;
          } else {
            questionText = randomVariation.word;
            answerText = `${randomVariation.reading}\n${randomVariation.meaning}`;
          }

          document.getElementById('questionText').innerHTML =
            questionText.replace(/\n/g, '<br>');
          document.getElementById('answerText').innerHTML = answerText.replace(
            /\n/g,
            '<br>'
          );
          document.getElementById('answerText').style.display = 'none';
          document.getElementById('showAnswerBtn').style.display = 'block';
          document.getElementById('answerButtons').style.display = 'none';

          session.showingAnswer = false;
          updateStudyProgress();

          const drawingSection = document.getElementById('drawingSection');
          if (drawingSection) {
            drawingSection.style.display = gameState.settings.showDrawing
              ? 'block'
              : 'none';
          }
        }

        function showAnswer() {
          document.getElementById('answerText').style.display = 'block';
          document.getElementById('showAnswerBtn').style.display = 'none';
          document.getElementById('answerButtons').style.display = 'flex';
          gameState.studySession.showingAnswer = true;
        }

        function submitAnswer(difficulty) {
    const session = gameState.studySession;
    const currentKanji = session.kanji[session.currentIndex];

    updateKanjiAfterReview(currentKanji, difficulty);

    if (difficulty >= 3) {
      session.correct++;
    }

    // Save immediately after updating kanji data
    saveGameData().catch(error => console.error('Failed to save after answer:', error));

    session.currentIndex++;

    if (session.currentIndex >= session.kanji.length) {
      alert(
        `Study session complete! Score: ${session.correct}/${session.total}`
      );
      saveGameData().then(() => {
        loadScene('dashboardScene');
      });
    } else {
      displayCurrentQuestion();
    }
  }

        function updateStudyProgress() {
          const session = gameState.studySession;
          const progress = ((session.currentIndex + 1) / session.total) * 100;

          document.getElementById('studyProgress').textContent = `${
            session.currentIndex + 1
          }/${session.total}`;
          document.getElementById('studyProgressBar').style.width =
            progress + '%';
        }

        // SRS System Implementation
        function updateKanjiAfterReview(kanji, difficulty) {
          const now = new Date();
          kanji.lastReview = now;
          kanji.totalReviews++;

          if (difficulty >= 3) {
            kanji.correctReviews++;
            kanji.consecutiveCorrect++;
          } else {
            kanji.consecutiveCorrect = 0;
          }

          if (difficulty < 3) {
            kanji.ease = Math.max(1.3, kanji.ease - 0.2);
            kanji.interval = 1;
          } else {
            if (difficulty === 3) {
              kanji.interval = Math.round(kanji.interval * kanji.ease);
            } else if (difficulty === 4) {
              kanji.ease += 0.1;
              kanji.interval = Math.round(kanji.interval * kanji.ease * 1.2);
            }
          }

          kanji.interval = Math.min(
            kanji.interval,
            gameState.settings.maxInterval
          );
          kanji.nextReview = new Date(
            now.getTime() + kanji.interval * 24 * 60 * 60 * 1000
          );

          if (kanji.consecutiveCorrect >= 3 && !kanji.learned) {
            kanji.learned = true;
          }
        }

        function isKanjiDueForReview(kanji) {
          if (!kanji.inReview) return false;
          if (!kanji.nextReview) return true;
          return new Date() >= kanji.nextReview;
        }

        function getFilteredVariations(kanji, jlptLevel) {
          if (jlptLevel === 'all') return kanji.variations;

          const exactMatches = kanji.variations.filter(
            (variation) => variation.jlpt === jlptLevel
          );
          return exactMatches.length > 0 ? exactMatches : kanji.variations;
        }

function initializeApp() {
  initializeKanjiData();
  startAutoSave();

  const storedToken = localStorage.getItem('authToken');
  if (storedToken) {
    gameState.authToken = storedToken;
    validateTokenAndAutoLogin(storedToken);
  } else {
    loadScene('loginScene');
    updateNavigationUI();
  }
}

      // Replace all placeholder functions with these implementations:

  function updateDecksScene() {
    const levelsDiv = document.getElementById('kanjiLevels');
    let html = '';

    for (let level = 10; level >= 1; level--) {
      const levelKanji = Array.from(gameState.kanjiData.values()).filter(
        (k) =>
          k.level === level &&
          (gameState.settings.jlptLevel === 'all' ||
            k.jlpt === gameState.settings.jlptLevel)
      );

      if (levelKanji.length === 0) continue;

      const inReviewCount = levelKanji.filter((k) => k.inReview).length;
      const isExpanded = gameState.expandedLevel === level;

      html += `
        <div class="level-header ${isExpanded ? 'expanded' : ''}" onclick="toggleLevel(${level})">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3>Level ${level}</h3>
              <p>${inReviewCount} in review / ${levelKanji.length} total</p>
            </div>
            <div>
              <button class="btn btn-primary" onclick="event.stopPropagation(); studyLevel(${level})">Study Level</button>
              <span style="margin-left: 15px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
            </div>
          </div>
        </div>
        <div class="kanji-grid ${isExpanded ? 'expanded' : ''}" id="level${level}Grid" style="display: ${isExpanded ? 'grid' : 'none'};">
          ${levelKanji.map(kanji => `
            <div class="kanji-card ${kanji.learned ? 'learned' : ''} ${kanji.inReview ? 'in-review' : ''}" 
                onclick="showKanjiDetail(${kanji.id})">
              <div class="kanji-character">${kanji.character}</div>
              <div class="kanji-translation">${kanji.meanings.join(', ')}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    levelsDiv.innerHTML = html;
  }
  function updateCramScene() {
    gameState.cramSession.selectedKanji.clear();

    const modeDropdown = document.getElementById('cramQuestionMode');
    if (modeDropdown) {
      modeDropdown.value = gameState.cramSession.questionMode;
    }

    const levelsDiv = document.getElementById('cramKanjiLevels');
    let html = '';

    for (let level = 10; level >= 1; level--) {
      const levelKanji = Array.from(gameState.kanjiData.values()).filter(
        (k) =>
          k.level === level &&
          (gameState.settings.jlptLevel === 'all' ||
            k.jlpt === gameState.settings.jlptLevel)
      );

      if (levelKanji.length === 0) continue;

      html += `
        <div class="level-header" onclick="toggleCramLevel(${level})">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3>Level ${level} (${levelKanji.length} kanji)</h3>
            </div>
            <div>
              <button class="btn btn-secondary" onclick="event.stopPropagation(); selectLevelKanji(${level})">Select All</button>
              <button class="btn btn-secondary" onclick="event.stopPropagation(); deselectLevelKanji(${level})">Deselect All</button>
            </div>
          </div>
        </div>
        <div class="kanji-grid expanded" id="cramLevel${level}Grid">
          ${levelKanji.map(kanji => `
            <div class="kanji-card" onclick="toggleKanjiSelection(${kanji.id})" id="cramKanji${kanji.id}">
              <div class="kanji-character">${kanji.character}</div>
              <div class="kanji-translation">${kanji.meanings.join(', ')}</div>
              <div style="position: absolute; top: 5px; right: 5px; font-size: 20px; display: none;" id="check${kanji.id}">‚úì</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    levelsDiv.innerHTML = html;
    updateCramButton();
  }

  function updateSettingsScene() {
    document.getElementById('profileName').value = gameState.settings.profileName;
    document.getElementById('maxLevel').value = gameState.settings.maxLevel;
    document.getElementById('jlptLevel').value = gameState.settings.jlptLevel;
    document.getElementById('maxInterval').value = gameState.settings.maxInterval;
    document.getElementById('showProgress').checked = gameState.settings.showProgress;
    document.getElementById('showDrawing').checked = gameState.settings.showDrawing;
  }

  function showKanjiDetail(kanjiId) {
    const kanji = gameState.kanjiData.get(kanjiId);
    if (!kanji) return;

    gameState.selectedKanji = kanji;

    document.getElementById('detailKanjiChar').textContent = kanji.character;
    document.getElementById('detailKanjiReading').textContent = kanji.readings.join(', ');
    document.getElementById('detailKanjiMeaning').textContent = kanji.meanings.join(', ');
    document.getElementById('detailLevel').textContent = kanji.level;
    document.getElementById('detailJLPT').textContent = kanji.jlpt;
    document.getElementById('detailStatus').textContent = kanji.learned
      ? 'Learned'
      : kanji.inReview
      ? 'In Review'
      : 'Not Learned';
    document.getElementById('detailAccuracy').textContent =
      kanji.totalReviews > 0
        ? Math.round((kanji.correctReviews / kanji.totalReviews) * 100) + '%'
        : '0%';
    document.getElementById('detailNextReview').textContent =
      kanji.nextReview ? kanji.nextReview.toLocaleDateString() : 'N/A';
    document.getElementById('mnemonicText').value = kanji.mnemonic || '';

    // Update buttons
    document.getElementById('addToReviewBtn').style.display = kanji.inReview ? 'none' : 'block';
    document.getElementById('removeFromReviewBtn').style.display = kanji.inReview ? 'block' : 'none';

    // Display variations
    displayVariations(kanji);

    loadScene('kanjiDetailScene');
  }

  function addKanjiToReview() {
    if (!gameState.selectedKanji) return;

    gameState.selectedKanji.inReview = true;
    gameState.selectedKanji.nextReview = new Date();

    showKanjiDetail(gameState.selectedKanji.id);
    saveGameData();
  }

  function removeKanjiFromReview() {
    if (!gameState.selectedKanji) return;

    gameState.selectedKanji.inReview = false;
    gameState.selectedKanji.nextReview = null;

    showKanjiDetail(gameState.selectedKanji.id);
    saveGameData();
  }

  function saveMnemonic() {
    if (!gameState.selectedKanji) return;

    const mnemonic = document.getElementById('mnemonicText').value;
    gameState.selectedKanji.mnemonic = mnemonic;

    alert('Mnemonic saved!');
    saveGameData();
  }

  function openDrawingScene() {
    if (!gameState.selectedKanji) return;

    document.getElementById('drawingKanjiChar').textContent = gameState.selectedKanji.character;
    document.getElementById('drawingKanjiMeaning').textContent = gameState.selectedKanji.meanings.join(', ');

    loadScene('drawingScene');
    initializeDrawingCanvas();
  }

  function clearCanvas() {
    const canvas = document.getElementById('drawingCanvas');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }

  function toggleEraser() {
    drawingState.isErasing = !drawingState.isErasing;
  }

  function selectAllKanji() {
    Array.from(gameState.kanjiData.values()).forEach((kanji) => {
      gameState.cramSession.selectedKanji.add(kanji.id);
      const card = document.getElementById(`cramKanji${kanji.id}`);
      const check = document.getElementById(`check${kanji.id}`);
      if (card) {
        card.classList.add('selected');
        check.style.display = 'block';
      }
    });
    updateCramButton();
  }

  function deselectAllKanji() {
    gameState.cramSession.selectedKanji.clear();
    document.querySelectorAll('.kanji-card').forEach((card) => {
      card.classList.remove('selected');
    });
    document.querySelectorAll('[id^="check"]').forEach((check) => {
      check.style.display = 'none';
    });
    updateCramButton();
  }

  function startCramSession() {
    if (gameState.cramSession.selectedKanji.size === 0) {
      alert('Please select some kanji first!');
      return;
    }

    const selectedKanji = Array.from(gameState.cramSession.selectedKanji)
      .map((id) => gameState.kanjiData.get(id))
      .sort(() => Math.random() - 0.5);

    gameState.cramSession = {
      kanji: selectedKanji,
      currentIndex: 0,
      showingAnswer: false,
      correct: 0,
      total: selectedKanji.length,
      selectedKanji: new Set(),
      questionMode: gameState.cramSession.questionMode,
    };

    loadScene('cramStudyScene');
    displayCramQuestion();
  }

  function updateCramQuestionMode() {
    const mode = document.getElementById('cramQuestionMode').value;
    gameState.cramSession.questionMode = mode;
  }

  function showCramAnswer() {
    document.getElementById('cramAnswerText').style.display = 'block';
    document.getElementById('cramShowAnswerBtn').style.display = 'none';
    document.getElementById('cramAnswerButtons').style.display = 'flex';

    gameState.cramSession.showingAnswer = true;
  }

  function submitCramAnswer(isCorrect) {
    const session = gameState.cramSession;

    if (isCorrect) {
      session.correct++;
    }

    session.currentIndex++;

    if (session.currentIndex >= session.kanji.length) {
      const percentage = Math.round((session.correct / session.total) * 100);
      alert(`Cram session complete!\nScore: ${session.correct}/${session.total} (${percentage}%)`);
      loadScene('cramScene');
    } else {
      displayCramQuestion();
    }
  }

  function saveProfileName() {
    const name = document.getElementById('profileName').value;
    gameState.settings.profileName = name;
    alert('Profile name saved!');
    saveGameData();
  }

async function saveSettings() {
    // Update gameState with form values
    gameState.settings.profileName = document.getElementById('profileName').value;
    gameState.settings.maxLevel = parseInt(document.getElementById('maxLevel').value);
    gameState.settings.jlptLevel = document.getElementById('jlptLevel').value;
    gameState.settings.maxInterval = parseInt(document.getElementById('maxInterval').value);
    gameState.settings.showProgress = document.getElementById('showProgress').checked;
    gameState.settings.showDrawing = document.getElementById('showDrawing').checked;

    try {
      if (gameState.isSignedIn && !gameState.isAnonymous && gameState.authToken) {
        // Save to server
        await apiCall('/settings', 'PUT', gameState.settings);
        console.log('Settings saved to server');
      }
      
      // Always save to localStorage as backup
      const saveData = {
        settings: gameState.settings,
        kanjiData: Array.from(gameState.kanjiData.entries()),
        lastSave: new Date().toISOString(),
      };
      localStorage.setItem('kanjiMasterSave', JSON.stringify(saveData));
      
      alert('Settings saved successfully!');
      
      // Update dashboard to reflect changes
      updateDashboard();
      
    } catch (error) {
      console.error('Failed to save settings:', error);
      
      // Still save locally
      const saveData = {
        settings: gameState.settings,
        kanjiData: Array.from(gameState.kanjiData.entries()),
        lastSave: new Date().toISOString(),
      };
      localStorage.setItem('kanjiMasterSave', JSON.stringify(saveData));
      
      alert('Settings saved locally (server error)');
    }
  }

  function clearMainCanvas() {
    const canvas = document.getElementById('mainDrawingCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function toggleMainEraser() {
    drawingState.isErasing = !drawingState.isErasing;
    const btn = event.target;
    btn.textContent = drawingState.isErasing ? 'Drawing Mode' : 'Toggle Eraser';
    btn.classList.toggle('btn-warning', drawingState.isErasing);
  }

  function toggleBackground() {
    const canvas = document.getElementById('mainDrawingCanvas');
    canvas.style.backgroundImage = canvas.style.backgroundImage
      ? ''
      : 'repeating-linear-gradient(0deg, transparent, transparent 24px, #ccc 25px), ' +
        'repeating-linear-gradient(90deg, transparent, transparent 24px, #ccc 25px)';
  }

  function closeModal() {
    const modal = document.getElementById('kanjiModal');
    if (modal) {
      modal.classList.remove('active');
    }
  }

  // Additional helper functions you'll need to add:

  function toggleKanjiSelection(kanjiId) {
    const kanji = gameState.kanjiData.get(kanjiId);
    const card = document.getElementById(`cramKanji${kanjiId}`);
    const check = document.getElementById(`check${kanjiId}`);

    if (gameState.cramSession.selectedKanji.has(kanjiId)) {
      gameState.cramSession.selectedKanji.delete(kanjiId);
      card.classList.remove('selected');
      check.style.display = 'none';
    } else {
      gameState.cramSession.selectedKanji.add(kanjiId);
      card.classList.add('selected');
      check.style.display = 'block';
    }

    updateCramButton();
  }

  function selectLevelKanji(level) {
    const levelKanji = Array.from(gameState.kanjiData.values()).filter((k) => k.level === level);
    levelKanji.forEach((kanji) => {
      gameState.cramSession.selectedKanji.add(kanji.id);
      const card = document.getElementById(`cramKanji${kanji.id}`);
      const check = document.getElementById(`check${kanji.id}`);
      if (card) {
        card.classList.add('selected');
        check.style.display = 'block';
      }
    });
    updateCramButton();
  }

  function deselectLevelKanji(level) {
    const levelKanji = Array.from(gameState.kanjiData.values()).filter((k) => k.level === level);
    levelKanji.forEach((kanji) => {
      gameState.cramSession.selectedKanji.delete(kanji.id);
      const card = document.getElementById(`cramKanji${kanji.id}`);
      const check = document.getElementById(`check${kanji.id}`);
      if (card) {
        card.classList.remove('selected');
        check.style.display = 'none';
      }
    });
    updateCramButton();
  }

  function updateCramButton() {
    const btn = document.getElementById('startCramBtn');
    const count = gameState.cramSession.selectedKanji.size;
    btn.textContent = `Start Cram (${count} selected)`;
    btn.disabled = count === 0;
  }

  function displayVariations(kanji) {
    const variationsDiv = document.getElementById('variationsList');

    if (!kanji.variations || kanji.variations.length === 0) {
      variationsDiv.innerHTML = '<p>No variations available for this kanji.</p>';
      return;
    }

    const html = kanji.variations
      .map(variation => `
        <div class="variation-item">
          <div style="font-size: 20px; font-weight: bold;">${variation.word}</div>
          <div style="color: #666;">${variation.reading}</div>
          <div>${variation.meaning}</div>
          <div style="display: flex; justify-content: space-between; margin-top: 5px;">
            <span style="font-size: 12px; color: #999;">${variation.type === 'on' ? "On'yomi" : "Kun'yomi"}</span>
            <span style="font-size: 12px; color: #667eea; font-weight: bold;">${variation.jlpt}</span>
          </div>
        </div>
      `)
      .join('');

    variationsDiv.innerHTML = html;
  }

  function displayCramQuestion() {
    const session = gameState.cramSession;
    const currentKanji = session.kanji[session.currentIndex];

    // Get filtered variations based on JLPT setting
    const filteredVariations = getFilteredVariations(currentKanji, gameState.settings.jlptLevel);
    
    if (filteredVariations.length === 0) {
      // If no variations match the JLPT filter, skip to next kanji
      session.currentIndex++;
      if (session.currentIndex >= session.kanji.length) {
        const percentage = Math.round((session.correct / session.total) * 100);
        alert(`Cram session complete!\nScore: ${session.correct}/${session.total} (${percentage}%)`);
        loadScene('cramScene');
        return;
      }
      displayCramQuestion();
      return;
    }

    // Pick a random variation from filtered list
    const randomVariation = filteredVariations[Math.floor(Math.random() * filteredVariations.length)];
    
    let questionText, answerText;

    if (session.questionMode === 'meaning-first') {
      // Show variation reading and meaning, answer with the word itself
      questionText = `${randomVariation.reading}\n${randomVariation.meaning}`;
      answerText = randomVariation.word;
    } else {
      // Show the word, answer with reading and meaning
      questionText = randomVariation.word;
      answerText = `${randomVariation.reading}\n${randomVariation.meaning}`;
    }

    document.getElementById('cramQuestionText').innerHTML = questionText.replace(/\n/g, '<br>');
    document.getElementById('cramAnswerText').innerHTML = answerText.replace(/\n/g, '<br>');
    document.getElementById('cramAnswerText').style.display = 'none';
    document.getElementById('cramShowAnswerBtn').style.display = 'block';
    document.getElementById('cramAnswerButtons').style.display = 'none';

    session.showingAnswer = false;
    updateCramProgress();
  }

  function updateCramProgress() {
    const session = gameState.cramSession;
    const progress = ((session.currentIndex + 1) / session.total) * 100;

    document.getElementById('cramProgress').textContent = `${session.currentIndex + 1}/${session.total}`;
    document.getElementById('cramCorrect').textContent = session.correct;
    document.getElementById('cramProgressBar').style.width = progress + '%';
  }

  function initializeDrawingCanvas() {
    const canvas = document.getElementById('mainDrawingCanvas');
    const ctx = canvas.getContext('2d');

    // Set up canvas
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Add event listeners
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events for mobile
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
  }

  function startDrawing(e) {
    drawingState.isDrawing = true;
    const rect = e.target.getBoundingClientRect();
    drawingState.lastX = e.clientX - rect.left;
    drawingState.lastY = e.clientY - rect.top;
  }

  function draw(e) {
    if (!drawingState.isDrawing) return;

    const canvas = e.target;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();

    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;

    if (drawingState.isErasing) {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = 20;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.lineWidth = 3;
    }

    ctx.beginPath();
    ctx.moveTo(drawingState.lastX, drawingState.lastY);
    ctx.lineTo(currentX, currentY);
    ctx.stroke();

    drawingState.lastX = currentX;
    drawingState.lastY = currentY;
  }

  function stopDrawing() {
    drawingState.isDrawing = false;
  }

  function toggleLevel(level) {
    gameState.expandedLevel = gameState.expandedLevel === level ? null : level;
    updateDecksScene();
  }

  function studyLevel(level) {
    const studyAmount = document.getElementById('studyAmount').value;
    const levelKanji = Array.from(gameState.kanjiData.values()).filter(
      (k) => k.level === level
    );

    let kanjiToStudy = [];
    if (studyAmount === 'all') {
      kanjiToStudy = levelKanji.filter((k) => !k.learned);
    } else {
      const amount = parseInt(studyAmount);
      kanjiToStudy = levelKanji.filter((k) => !k.learned).slice(0, amount);
    }

    if (kanjiToStudy.length === 0) {
      alert('No new kanji to study in this level!');
      return;
    }

    // Add to review and start study session
    kanjiToStudy.forEach((kanji) => {
      kanji.inReview = true;
      if (!kanji.nextReview) {
        kanji.nextReview = new Date();
      }
    });

    startStudySession(kanjiToStudy);
  }

  function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(
      e.type === 'touchstart'
        ? 'mousedown'
        : e.type === 'touchmove'
        ? 'mousemove'
        : 'mouseup',
      {
        clientX: touch.clientX,
        clientY: touch.clientY,
      }
    );

    e.target.dispatchEvent(mouseEvent);
  }


        // Start the application
        initializeApp();
        // Add this after the initializeApp() call
  window.addEventListener('beforeunload', async (event) => {
    if (gameState.isSignedIn && !gameState.isAnonymous) {
      // For modern browsers, we can't make the user wait, but we can try to save
      navigator.sendBeacon && navigator.sendBeacon('/api/kanji-progress', JSON.stringify({
        kanjiProgressData: Array.from(gameState.kanjiData.entries()).map(([id, kanji]) => [
          id,
          {
            learned: kanji.learned,
            inReview: kanji.inReview,
            interval: kanji.interval,
            ease: kanji.ease,
            consecutiveCorrect: kanji.consecutiveCorrect,
            totalReviews: kanji.totalReviews,
            correctReviews: kanji.correctReviews,
            lastReview: kanji.lastReview ? kanji.lastReview.toISOString() : null,
            nextReview: kanji.nextReview ? kanji.nextReview.toISOString() : null,
            mnemonic: kanji.mnemonic || '',
          },
        ])
      }));
    }
    
    // Always save to localStorage as backup
    const saveData = {
      settings: gameState.settings,
      kanjiData: Array.from(gameState.kanjiData.entries()),
      lastSave: new Date().toISOString(),
    };
    localStorage.setItem('kanjiMasterSave', JSON.stringify(saveData));
  });
      </script>
    </body>
  </html>
